<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>CineSync - Assista com Amigos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        #app-container {
            background: linear-gradient(135deg, #1e3a8a, #312e81, #4c1d95);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-left-hidden {
            transform: translateX(-100%);
        }
        .sidebar-right-hidden {
            transform: translateX(100%);
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        
        #video-player-container {
            background: #000;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Hide default video controls */
        video::-webkit-media-controls { display: none !important; }
        video::-webkit-media-controls-enclosure { display: none !important; }
        video::-webkit-media-controls-panel { display: none !important; }
        
        /* Custom progress bar */
        #progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 5px; background: rgba(255, 255, 255, 0.3); border-radius: 5px; outline: none; transition: height 0.2s; cursor: pointer;}
        #progress-bar:hover { height: 8px; }
        #progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #3b82f6; border-radius: 50%; cursor: pointer; transform: scale(0); transition: transform 0.2s; }
        #video-controls:hover #progress-bar::-webkit-slider-thumb, #progress-bar:active::-webkit-slider-thumb { transform: scale(1); }
        #video-controls.host-controls #progress-bar { cursor: pointer; }
        #video-controls.guest-controls #progress-bar { cursor: not-allowed; }
    </style>
</head>
<body class="bg-slate-900 text-white overflow-hidden">

    <div id="app-container" class="w-full h-screen">
        <!-- Tela de Login/Entrada -->
        <div id="login-screen" class="flex flex-col items-center justify-center w-full h-full p-4">
            <!-- ... (conteúdo da tela de login inalterado) ... -->
            <div class="bg-black bg-opacity-40 p-8 rounded-2xl shadow-2xl w-full max-w-md text-center backdrop-blur-sm border border-white/10">
                <div class="flex items-center justify-center mb-6">
                    <i data-lucide="clapperboard" class="w-10 h-10 text-blue-400 mr-3"></i>
                    <h1 class="text-4xl font-bold">CineSync</h1>
                </div>
                <p class="text-slate-300 mb-8">Crie uma sala ou entre em uma para assistir com seus amigos.</p>
                <div class="space-y-4">
                    <input type="text" id="username-input" placeholder="Digite seu nome" class="w-full bg-slate-800/50 border-2 border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    <button id="create-room-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg flex items-center justify-center transition-transform hover:scale-105">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                        Criar Nova Sala
                    </button>
                    <div class="flex items-center">
                        <hr class="flex-grow border-slate-600">
                        <span class="px-4 text-slate-400">OU</span>
                        <hr class="flex-grow border-slate-600">
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="room-id-input" placeholder="Cole o código da sala" class="w-full bg-slate-800/50 border-2 border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        <button id="join-room-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg flex items-center justify-center transition-transform hover:scale-105">
                            <i data-lucide="arrow-right-to-line" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                 <p id="error-message" class="text-red-400 mt-4 h-5"></p>
            </div>
        </div>

        <!-- Tela Principal do App -->
        <main id="main-app" class="hidden w-full h-screen flex flex-col">
            <!-- Header -->
            <header class="bg-black bg-opacity-30 p-2 shadow-lg flex items-center justify-between z-20 flex-shrink-0">
                <!-- ... (conteúdo do header inalterado) ... -->
                 <div class="flex items-center gap-4">
                     <button id="toggle-participants-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <i data-lucide="clapperboard" class="w-7 h-7 text-blue-400"></i>
                        <h1 class="text-xl font-bold hidden sm:block">CineSync</h1>
                    </div>
                </div>
                <div id="room-info" class="flex items-center gap-2 bg-slate-800/50 px-4 py-2 rounded-lg border border-slate-600">
                    <span class="text-slate-300 hidden md:inline">SALA:</span>
                    <span id="room-id-display" class="font-mono text-lg text-blue-300"></span>
                    <button id="copy-room-id-btn" class="p-1 rounded-md hover:bg-white/10 transition-colors">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="flex items-center gap-4">
                    <button id="app-fullscreen-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                        <i id="app-fullscreen-icon" data-lucide="maximize" class="w-6 h-6"></i>
                    </button>
                    <button id="toggle-chat-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors">
                        <i data-lucide="message-square" class="w-6 h-6"></i>
                    </button>
                </div>
            </header>

            <!-- Conteúdo Principal (Vídeo e Sidebars) -->
            <div class="flex-grow flex relative overflow-hidden">
                <!-- Sidebar de Participantes (Esquerda) -->
                <aside id="participants-sidebar" class="sidebar sidebar-left-hidden absolute md:relative top-0 left-0 h-full w-64 md:w-72 bg-slate-900/80 backdrop-blur-md border-r border-slate-700/50 flex-shrink-0 z-30 flex flex-col">
                    <!-- ... (conteúdo da sidebar de participantes inalterado) ... -->
                    <div class="flex items-center justify-between p-4 border-b border-slate-700">
                        <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="users" class="w-5 h-5"></i>Participantes</h2>
                        <button id="close-participants-btn" class="md:hidden p-1 rounded-full hover:bg-white/10">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <ul id="participants-list" class="flex-grow p-2 space-y-2 overflow-y-auto custom-scrollbar"></ul>
                </aside>

                <!-- Área do Vídeo e Controles -->
                <div class="flex-grow flex flex-col p-2 sm:p-4 gap-4 overflow-y-auto custom-scrollbar">
                    <div id="video-player-container" class="w-full aspect-video flex-shrink-0 flex items-center justify-center relative group bg-black rounded-lg">
                        <video id="video-player" class="w-full h-full rounded-lg" playsinline></video>
                        <div id="video-placeholder-new" class="absolute inset-0 flex flex-col items-center justify-center text-center text-slate-400 pointer-events-none">
                            <i data-lucide="video" class="w-16 h-16 mx-auto mb-4"></i>
                            <h3 class="text-xl font-semibold">O vídeo aparecerá aqui</h3>
                            <p>Cole um link de vídeo (.mp4) abaixo para começar.</p>
                        </div>
                        <div id="video-controls" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-3 pt-6 opacity-0 group-hover:opacity-100 focus-within:opacity-100 transition-opacity duration-300 flex flex-col gap-2">
                           <input type="range" id="progress-bar" value="0" step="0.1" class="w-full">
                           <div class="flex items-center justify-between text-sm">
                               <div class="flex items-center gap-3">
                                   <button id="play-pause-btn" class="p-2">
                                       <i id="play-pause-icon" data-lucide="play" class="w-6 h-6"></i>
                                   </button>
                                   <div id="time-display" class="font-mono w-28">00:00 / 00:00</div>
                               </div>
                               <button id="video-fullscreen-btn" class="p-2">
                                   <i data-lucide="maximize" class="w-6 h-6"></i>
                               </button>
                           </div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-2 flex-shrink-0">
                        <input type="text" id="video-url-input" placeholder="Cole o link de um vídeo .mp4 aqui" class="flex-grow bg-slate-800/50 border-2 border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        <button id="load-video-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-transform hover:scale-105">
                            <i data-lucide="play" class="w-5 h-5"></i> Carregar
                        </button>
                    </div>
                </div>

                <!-- Sidebar de Chat (Direita) -->
                <aside id="chat-sidebar" class="sidebar sidebar-right-hidden absolute md:relative top-0 right-0 h-full w-72 md:w-80 bg-slate-900/80 backdrop-blur-md border-l border-slate-700/50 flex-shrink-0 z-30 flex flex-col">
                    <!-- ... (conteúdo da sidebar de chat inalterado) ... -->
                    <div class="flex items-center justify-between p-4 border-b border-slate-700">
                        <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="message-square" class="w-5 h-5"></i>Chat da Sala</h2>
                         <button id="close-chat-btn" class="md:hidden p-1 rounded-full hover:bg-white/10">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar"></div>
                    <form id="chat-form" class="p-2 border-t border-slate-700 flex gap-2">
                        <input type="text" id="chat-input" placeholder="Digite uma mensagem..." autocomplete="off" class="flex-grow bg-slate-800/50 border-2 border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg shadow-lg flex items-center justify-center transition-transform hover:scale-105 aspect-square">
                            <i data-lucide="send" class="w-6 h-6"></i>
                        </button>
                    </form>
                </aside>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cinesync-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const ROOMS_COLLECTION_PATH = `artifacts/${appId}/public/data/cinesync_rooms`;

        // --- Referências do DOM ---
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const usernameInput = document.getElementById('username-input');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const roomIdInput = document.getElementById('room-id-input');
        const errorMessage = document.getElementById('error-message');
        const participantsSidebar = document.getElementById('participants-sidebar');
        const chatSidebar = document.getElementById('chat-sidebar');
        const toggleParticipantsBtn = document.getElementById('toggle-participants-btn');
        const closeParticipantsBtn = document.getElementById('close-participants-btn');
        const toggleChatBtn = document.getElementById('toggle-chat-btn');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const roomIdDisplay = document.getElementById('room-id-display');
        const copyRoomIdBtn = document.getElementById('copy-room-id-btn');
        const participantsList = document.getElementById('participants-list');
        const videoUrlInput = document.getElementById('video-url-input');
        const loadVideoBtn = document.getElementById('load-video-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        
        // --- Referências do Player Customizado ---
        const videoPlayerContainer = document.getElementById('video-player-container');
        const videoPlayer = document.getElementById('video-player');
        const videoPlaceholder = document.getElementById('video-placeholder-new');
        const videoControls = document.getElementById('video-controls');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const progressBar = document.getElementById('progress-bar');
        const timeDisplay = document.getElementById('time-display');
        const videoFullscreenBtn = document.getElementById('video-fullscreen-btn');
        
        // --- Estado do App ---
        let currentUser = null;
        let currentRoomId = null;
        let isHost = false;
        let isUpdatingFromFirestore = false; // Flag para evitar loops de sincronização
        let unsubscribeRoom = null, unsubscribeParticipants = null, unsubscribeMessages = null;

        // --- AUTENTICAÇÃO E LÓGICA DE SALA (sem alterações) ---
        onAuthStateChanged(auth, async (user) => { if (user) { currentUser = user; } else { try { if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } else { await signInAnonymously(auth); } } catch (error) { console.error("Authentication Error:", error); errorMessage.textContent = "Erro de autenticação."; } } });
        const handleJoinRoom = async (roomId) => { const username = usernameInput.value.trim(); if (!username || !currentUser) { errorMessage.textContent = !username ? "Por favor, digite seu nome." : "Aguardando autenticação..."; return; } const roomRef = doc(db, ROOMS_COLLECTION_PATH, roomId); const roomSnap = await getDoc(roomRef); if (!roomSnap.exists()) { errorMessage.textContent = "Essa sala não existe."; return; } currentRoomId = roomId; const participantRef = doc(db, `${ROOMS_COLLECTION_PATH}/${roomId}/participants`, currentUser.uid); await setDoc(participantRef, { username, joinedAt: serverTimestamp() }); loginScreen.classList.add('hidden'); mainApp.classList.remove('hidden'); mainApp.classList.add('flex'); roomIdDisplay.textContent = roomId; setupRealtimeListeners(roomId); };
        createRoomBtn.addEventListener('click', async () => { const newRoomId = Math.random().toString(36).substring(2, 8).toUpperCase(); const roomRef = doc(db, ROOMS_COLLECTION_PATH, newRoomId); await setDoc(roomRef, { createdAt: serverTimestamp(), videoUrl: "", isPlaying: false, currentTime: 0, hostId: currentUser.uid, lastUpdateBy: currentUser.uid }); await handleJoinRoom(newRoomId); });
        joinRoomBtn.addEventListener('click', () => { const roomId = roomIdInput.value.trim().toUpperCase(); if (roomId) { handleJoinRoom(roomId); } else { errorMessage.textContent = "Por favor, digite o código da sala."; } });

        // --- LISTENERS EM TEMPO REAL ---
        function setupRealtimeListeners(roomId) {
            if (unsubscribeRoom) unsubscribeRoom();
            if (unsubscribeParticipants) unsubscribeParticipants();
            if (unsubscribeMessages) unsubscribeMessages();

            // Listener da Sala (Vídeo e Estado)
            const roomRef = doc(db, ROOMS_COLLECTION_PATH, roomId);
            unsubscribeRoom = onSnapshot(roomRef, (docSnap) => {
                if (!docSnap.exists()) return;
                const data = docSnap.data();
                isHost = data.hostId === currentUser.uid;
                
                // Atualiza a URL do vídeo
                if (data.videoUrl && videoPlayer.src !== data.videoUrl) {
                    videoPlayer.src = data.videoUrl;
                    videoPlaceholder.classList.add('hidden');
                } else if (!data.videoUrl) {
                    videoPlayer.src = '';
                    videoPlaceholder.classList.remove('hidden');
                }

                // Ignora atualizações de estado que o próprio usuário enviou
                if (data.lastUpdateBy === currentUser.uid) return;

                isUpdatingFromFirestore = true;
                
                // Sincroniza Play/Pause
                if (data.isPlaying && videoPlayer.paused) {
                    videoPlayer.play().catch(e => console.log("Playback foi impedido pelo navegador."));
                } else if (!data.isPlaying && !videoPlayer.paused) {
                    videoPlayer.pause();
                }

                // Sincroniza tempo do vídeo (com uma tolerância para evitar saltos)
                if (Math.abs(videoPlayer.currentTime - data.currentTime) > 2) {
                    videoPlayer.currentTime = data.currentTime;
                }
                
                // Habilita/desabilita controles para não-hosts
                videoControls.classList.toggle('host-controls', isHost);
                videoControls.classList.toggle('guest-controls', !isHost);
                progressBar.disabled = !isHost;
                playPauseBtn.disabled = !isHost;

                setTimeout(() => { isUpdatingFromFirestore = false; }, 100);
            });

            // Listeners de Participantes e Mensagens (sem alterações)
            const participantsRef = collection(db, `${ROOMS_COLLECTION_PATH}/${roomId}/participants`);
            unsubscribeParticipants = onSnapshot(participantsRef, (snapshot) => { participantsList.innerHTML = ''; snapshot.forEach((doc) => { const p = doc.data(); const li = document.createElement('li'); li.className = 'flex items-center gap-3 p-2 bg-slate-800/50 rounded-lg'; li.innerHTML = `<div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div><span class="font-medium">${p.username}</span>`; participantsList.appendChild(li); }); });
            const messagesRef = collection(db, `${ROOMS_COLLECTION_PATH}/${roomId}/messages`); const q = query(messagesRef, orderBy('timestamp'));
            unsubscribeMessages = onSnapshot(q, (snapshot) => { snapshot.docChanges().forEach((change) => { if (change.type === "added") { const msgData = change.doc.data(); const msgEl = document.createElement('div'); const isMe = msgData.senderId === currentUser.uid; msgEl.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`; msgEl.innerHTML = `<div class="text-xs text-slate-400 mb-1 px-1 ${isMe ? 'text-right' : 'text-left'}">${msgData.senderName}</div><div class="max-w-xs text-sm px-3 py-2 rounded-xl ${isMe ? 'bg-blue-600 rounded-br-none' : 'bg-slate-700 rounded-bl-none'}">${msgData.text}</div>`; chatMessages.appendChild(msgEl); } }); chatMessages.scrollTop = chatMessages.scrollHeight; });
        }
        
        // --- FUNÇÕES DE CONTROLE DO PLAYER ---
        const updateRoomVideoState = (newState) => {
            if (!isHost || !currentRoomId) return;
            const roomRef = doc(db, ROOMS_COLLECTION_PATH, currentRoomId);
            updateDoc(roomRef, { ...newState, lastUpdateBy: currentUser.uid });
        };
        
        const formatTime = (time) => { const minutes = Math.floor(time / 60); const seconds = Math.floor(time % 60); return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; };
        
        // --- EVENT LISTENERS DO PLAYER ---
        videoPlayer.addEventListener('loadedmetadata', () => {
            progressBar.max = videoPlayer.duration;
            timeDisplay.textContent = `${formatTime(videoPlayer.currentTime)} / ${formatTime(videoPlayer.duration)}`;
        });
        
        videoPlayer.addEventListener('timeupdate', () => {
            progressBar.value = videoPlayer.currentTime;
            timeDisplay.textContent = `${formatTime(videoPlayer.currentTime)} / ${formatTime(videoPlayer.duration)}`;
        });

        videoPlayer.addEventListener('play', () => {
            playPauseIcon.setAttribute('data-lucide', 'pause'); lucide.createIcons();
            if (!isUpdatingFromFirestore) updateRoomVideoState({ isPlaying: true });
        });

        videoPlayer.addEventListener('pause', () => {
            playPauseIcon.setAttribute('data-lucide', 'play'); lucide.createIcons();
            if (!isUpdatingFromFirestore) updateRoomVideoState({ isPlaying: false, currentTime: videoPlayer.currentTime });
        });

        videoPlayer.addEventListener('seeked', () => {
            if (!isUpdatingFromFirestore) updateRoomVideoState({ currentTime: videoPlayer.currentTime });
        });

        playPauseBtn.addEventListener('click', () => {
            if (!isHost) return;
            if (videoPlayer.paused) videoPlayer.play();
            else videoPlayer.pause();
        });

        progressBar.addEventListener('input', () => {
             if (!isHost) { progressBar.value = videoPlayer.currentTime; return; }
             videoPlayer.currentTime = progressBar.value;
        });

        loadVideoBtn.addEventListener('click', () => {
            const url = videoUrlInput.value.trim();
            if (url && currentRoomId && isHost) {
                 updateRoomVideoState({ videoUrl: url, isPlaying: false, currentTime: 0 });
            } else if (!isHost) {
                alert("Apenas o host da sala pode carregar um novo vídeo.");
            }
        });
        
        videoFullscreenBtn.addEventListener('click', () => { if (videoPlayerContainer.requestFullscreen) videoPlayerContainer.requestFullscreen(); });

        // --- CONTROLES DE INTERFACE (sem alterações) ---
        const toggleSidebar = (sidebar, action) => { const isLeft = sidebar.id.includes('participants'); const hiddenClass = isLeft ? 'sidebar-left-hidden' : 'sidebar-right-hidden'; if (action === 'open') sidebar.classList.remove(hiddenClass); else if (action === 'close') sidebar.classList.add(hiddenClass); else sidebar.classList.toggle(hiddenClass); };
        toggleParticipantsBtn.addEventListener('click', () => toggleSidebar(participantsSidebar));
        closeParticipantsBtn.addEventListener('click', () => toggleSidebar(participantsSidebar, 'close'));
        toggleChatBtn.addEventListener('click', () => toggleSidebar(chatSidebar));
        closeChatBtn.addEventListener('click', () => toggleSidebar(chatSidebar, 'close'));
        copyRoomIdBtn.addEventListener('click', () => { navigator.clipboard.writeText(currentRoomId).then(() => { const icon = copyRoomIdBtn.querySelector('i'); icon.setAttribute('data-lucide', 'check'); lucide.createIcons(); setTimeout(() => { icon.setAttribute('data-lucide', 'copy'); lucide.createIcons(); }, 2000); }); });
        const appFullscreenBtn = document.getElementById('app-fullscreen-btn'); appFullscreenBtn.addEventListener('click', () => { const icon = document.getElementById('app-fullscreen-icon'); if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else { if (document.exitFullscreen) { document.exitFullscreen(); } } }); document.addEventListener('fullscreenchange', () => { const icon = document.getElementById('app-fullscreen-icon'); if (!document.fullscreenElement) { icon.setAttribute('data-lucide', 'maximize'); } else { icon.setAttribute('data-lucide', 'minimize'); } lucide.createIcons(); });
        chatForm.addEventListener('submit', async (e) => { e.preventDefault(); const text = chatInput.value.trim(); if (text && currentUser && currentRoomId) { const username = usernameInput.value.trim(); await addDoc(collection(db, `${ROOMS_COLLECTION_PATH}/${currentRoomId}/messages`), { text, senderName: username, senderId: currentUser.uid, timestamp: serverTimestamp() }); chatInput.value = ''; } });
        window.addEventListener('beforeunload', () => { if(currentUser && currentRoomId) { const participantRef = doc(db, `${ROOMS_COLLECTION_PATH}/${currentRoomId}/participants`, currentUser.uid); deleteDoc(participantRef); } });
        
        lucide.createIcons();
    </script>
</body>
</html>

