<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siga a Receita - Deluxe Chef!</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (√çcones) CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Font Inter (Estilo Google) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Estilo base com a fonte Inter */
        body {
            font-family: 'Inter', sans-serif;
            /* Fundo gradiente vibrante e vivo */
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            overflow: hidden; /* Prevenir scroll */
        }

        /* Container principal do jogo */
        #game-container {
            /* Efeito de vidro fosco (glassmorphism) */
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        /* Bot√µes principais (Menu e A√ß√£o) */
        .btn-main {
            transition: all 0.2s ease;
            transform: scale(1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .btn-main:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .btn-main:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Estilo dos bot√µes de ingrediente */
        .ingredient-btn {
            transition: all 0.15s ease;
            background: #fff;
            color: #333;
            border: 2px solid #ddd;
        }
        .ingredient-btn:hover {
            border-color: #a78bfa; /* Roxo */
            transform: translateY(-2px);
        }
        .ingredient-btn:active {
            transform: scale(0.92);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            background-color: #a78bfa; /* Roxo */
            color: white;
            border-color: #a78bfa;
        }
        
        /* (NOVO) Estilo para o card de "Subir de Ranque" no mercado */
        .rank-up-card {
            border: 3px solid #f59e0b; /* Amarelo/Ouro */
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6);
            transform: scale(1.02);
            background-color: #fffbeb; /* Fundo amarelo claro */
        }
        .rank-up-card:hover {
            background-color: #fffbeb;
        }

        /* Anima√ß√µes */
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in { animation: pop-in 0.3s ease-out forwards; }
        
        @keyframes slide-in-bottom {
            0% { transform: translateY(100%); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-in-bottom { animation: slide-in-bottom 0.5s ease-out forwards; }

        @keyframes countdown {
            from { width: 100%; }
            to { width: 0%; }
        }
        .timer-bar-inner-animate { animation: countdown 10s linear forwards; }
        
        /* Bal√£o de fala melhorado */
        .speech-bubble {
            position: relative;
            background: #f3f4f6; /* Cinza claro */
            border-radius: .4em;
            padding: 1rem 1.25rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 15%;
            width: 0; height: 0;
            border: 20px solid transparent;
            border-top-color: #f3f4f6; /* Cor igual ao bal√£o */
            border-bottom: 0;
            margin-left: -10px;
            margin-bottom: -20px;
        }
        
        /* Classes de feedback */
        .message-success { color: #10b981; /* Verde */ transform: scale(1); opacity: 1; }
        .message-error { color: #ef4444; /* Vermelho */ transform: scale(1); opacity: 1; }
        #message-box {
            transition: all 0.3s ease;
            transform: scale(0.8);
            opacity: 0;
            height: 2.5rem; /* Altura fixa */
        }
        
        /* Combo (Streak) */
        @keyframes pulse-orange {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.9; }
        }
        .animate-pulse-orange { animation: pulse-orange 0.3s ease-out; }

        /* Evitar sele√ß√£o de texto */
        .no-select {
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+/Edge */
            user-select: none; /* Padr√£o */
        }

        /* Estilo para as "telas" */
        .screen {
            display: none; /* Oculto por padr√£o */
            flex-direction: column;
            width: 100%;
            height: 100%;
            animation: pop-in 0.4s ease-out;
        }
        .screen.active {
            display: flex; /* Vis√≠vel quando ativo */
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen no-select">

    <!-- Container Principal do App (Mobile-First) -->
    <div id="game-container" class="w-full max-w-md h-full md:h-[95vh] md:max-h-[800px] bg-white shadow-xl rounded-2xl flex flex-col overflow-hidden relative">

        <!-- ====================================================== -->
        <!-- 1. TELA DE MENU (MODIFICADA COM RANQUE)                -->
        <!-- ====================================================== -->
        <div id="menu-screen" class="screen active p-8 flex-col items-center justify-center text-center">
            
            <!-- (NOVO) Display de Ranque -->
            <div id="rank-display" class="text-center mb-6 w-full">
                <div id="rank-icon" class="text-8xl mb-2">üßº</div>
                <h2 id="rank-name" class="text-3xl font-bold text-gray-700">Lava-pratos</h2>
            </div>

            <!-- (NOVO) Meta para Pr√≥ximo Ranque -->
            <div id="rank-goal" class="bg-gray-100 p-4 rounded-xl mb-6 text-center w-full shadow-inner">
                <h4 class="text-lg font-bold text-purple-600">Pr√≥ximo N√≠vel</h4>
                <p id="rank-goal-text" class="text-gray-600">Compre a receita "Salada" no Mercado!</p>
            </div>

            <button id="play-button" class="btn-main w-full bg-green-500 text-white font-bold px-12 py-5 rounded-xl text-3xl shadow-lg mb-6">
                <i class="fas fa-play mr-3"></i> Pr√≥ximo Pedido
            </button>
            <button id="market-button" class="btn-main w-full bg-blue-500 text-white font-bold px-12 py-5 rounded-xl text-3xl shadow-lg">
                <i class="fas fa-store mr-3"></i> Mercado
            </button>
            <div class="mt-auto text-gray-500 text-sm">
                Chef Deluxe v2.0
            </div>
        </div>

        <!-- ====================================================== -->
        <!-- 2. TELA DE JOGO (MODIFICADA)                           -->
        <!-- ====================================================== -->
        <div id="game-screen" class="screen">
            <!-- Header (Dinheiro e Pausa) -->
            <header class="bg-white/80 backdrop-blur-sm border-b border-gray-200 p-4 flex justify-between items-center z-10">
                <button id="pause-button" class="text-gray-500 hover:text-purple-600 transition-colors duration-200 text-3xl w-10 h-10 flex items-center justify-center">
                    <i class="fas fa-pause"></i>
                </button>
                
                <div class="flex items-center space-x-3">
                    <div id="streak-display" class="text-orange-500 font-bold text-xl transition-transform duration-300" title="Combo de Acertos"></div>
                    <div id="money-display-game" class="bg-green-500 text-white font-bold px-5 py-2 rounded-full text-lg shadow-md transition-all duration-300">
                        $50
                    </div>
                </div>
            </header>

            <!-- √Årea do Jogo -->
            <main class="flex-1 flex flex-col p-4 overflow-hidden relative text-gray-800">
                <!-- Cliente e Pedido -->
                <div id="order-area" class="flex flex-col items-center mb-4">
                    <div id="npc-display" class="text-8xl transition-transform duration-300"></div>
                    <div id="order-display" class="speech-bubble text-gray-900 font-bold text-center mt-4 w-52 transition-transform duration-200">
                        <span id="dish-emoji" class="text-6xl block"></span>
                        <span id="dish-name" class="block mt-2 text-lg"></span>
                    </div>
                </div>

                <!-- Receita -->
                <div id="recipe-list" class="text-center text-2xl h-10 mb-2 flex justify-center items-center space-x-2">
                    <!-- Receita: üçû üßà üßÄ üçû -->
                </div>
                
                <!-- Barra de Tempo -->
                <div class="w-full bg-gray-200 rounded-full h-5 mb-2 overflow-hidden shadow-inner border border-gray-300">
                    <div id="timer-bar-inner" class="h-full rounded-full bg-gradient-to-r from-red-500 to-orange-400 transition-all duration-300"></div>
                </div>
                <div id="timer-text" class="text-center font-bold text-lg mb-2 text-gray-700">Tempo: 12s</div>

                <!-- Prato do Jogador -->
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-3 min-h-[7rem] mb-4 shadow-inner flex flex-wrap justify-center items-center gap-2" id="player-plate">
                    <!-- Ingredientes selecionados -->
                </div>

                <!-- Mensagem de Feedback -->
                <div id="message-box" class="text-center text-2xl font-bold">
                    <!-- Mensagens de "Perfeito!" ou "Errado!" -->
                </div>
            </main>

            <!-- Bandeja de Ingredientes -->
            <footer class="bg-gray-100 p-4 shadow-inner border-t-2 border-gray-200">
                <div id="ingredient-bin" class="grid grid-cols-5 gap-2 justify-items-center">
                    <!-- Bot√µes de ingredientes ser√£o injetados aqui -->
                </div>
            </footer>
        </div>

        <!-- ====================================================== -->
        <!-- 3. TELA DE MERCADO (MODIFICADA)                        -->
        <!-- ====================================================== -->
        <div id="market-screen" class="screen">
            <!-- Header do Mercado -->
            <header class="bg-white/80 backdrop-blur-sm border-b border-gray-200 p-4 flex justify-between items-center z-10 w-full">
                <button id="menu-button-market" class="text-gray-500 hover:text-purple-600 transition-colors duration-200 text-3xl w-10 h-10 flex items-center justify-center">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="text-2xl font-bold text-purple-600">Mercado</h2>
                <div id="money-display-market" class="bg-green-500 text-white font-bold px-5 py-2 rounded-full text-lg shadow-md transition-all duration-300">
                    $50
                </div>
            </header>

            <!-- Lista de Itens do Mercado -->
            <main class="flex-1 p-4 overflow-y-auto w-full space-y-3">
                <div id="market-items-grid" class="space-y-3">
                    <!-- Cards de receitas ser√£o injetados aqui -->
                </div>
            </main>
        </div>

        <!-- ====================================================== -->
        <!-- MODAIS (SOBREPOSI√á√ÉO)                                  -->
        <!-- ====================================================== -->

        <!-- Tela de Pausa (MODAL) -->
        <div id="pause-screen" class="hidden absolute inset-0 bg-black/70 z-40 flex flex-col items-center justify-center p-8 text-center backdrop-blur-sm">
            <i class="fas fa-pause-circle text-8xl text-white mb-6"></i>
            <h2 class="text-5xl font-bold mb-10 text-white">Pausado</h2>
            <button id="resume-button" class="btn-main w-full max-w-xs bg-green-500 text-white font-bold px-12 py-4 rounded-xl text-2xl shadow-lg mb-4">
                Continuar
            </button>
            <button id="menu-button-pause" class="btn-main w-full max-w-xs bg-red-500 text-white font-bold px-12 py-4 rounded-xl text-2xl shadow-lg">
                Voltar ao Menu
            </button>
        </div>

        <!-- Mensagem de Feedback do Mercado (MODAL) -->
        <div id="market-message-modal" class="hidden absolute inset-0 bg-black/70 z-50 flex flex-col items-center justify-center p-8 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl text-center w-full max-w-sm animate-pop-in">
                <i id="market-message-icon" class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                <h3 id="market-message-title" class="text-2xl font-bold text-gray-800 mb-2"></h3>
                <p id="market-message-text" class="text-gray-600 mb-6"></p>
                <button id="market-message-close" class="btn-main w-full bg-purple-500 text-white font-bold py-3 rounded-lg text-lg">
                    OK
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- 1. DEFINI√á√ÉO DE DADOS DO JOGO ---

        const NPCS = ["üë©‚Äçüíº", "üßë‚Äçüíª", "üë®‚Äçüé®", "üë©‚ÄçüöÄ", "üßë‚Äçüöí", "üëÆ‚Äç‚ôÄÔ∏è", "üë∑‚Äç‚ôÇÔ∏è", "üë©‚Äç‚öïÔ∏è", "üßë‚Äçüé§", "üë®‚Äçüåæ"];
        
        // (MAIS INGREDIENTES)
        const ALL_INGREDIENTS = [
            "üçû", "ü•¨", "ü•©", "üßÄ", "üçÖ", "ü•í", "üßÖ", "üå∂Ô∏è", "üåÆ", "üçô", 
            "üêü", "ü•ë", "ü•ö", "ü•ì", "üçÑ", "üå≠", "üçó", "üåΩ", "ü¶ê", "üçï",
            "üßà", "üçÜ", "ü•î", "üåø", "üçú", "üçì", "üçç",
            "ü•õ", "üçØ", "üßá", "ü•û", "ü•¶", "ü•ï", "ü´ê", "üçö", "ü•ü", "üçã"
        ];
        
        // (MAIS RECEITAS + Estrutura de Ranque)
        const ALL_RECIPES = [
            // name: Nome do prato
            // emoji: Emoji do prato
            // price: Pre√ßo no mercado
            // baseRecipe: A receita m√≠nima obrigat√≥ria
            // optionalIngredients: Ingredientes que podem ser adicionados se o jogador os tiver desbloqueado
            
            // Tier 1
            { name: "Misto Quente", emoji: "ü•™", price: 0, baseRecipe: ["üçû", "üßà", "üßÄ", "üçû"], optionalIngredients: ["üçÖ"] }, // Inicial
            { name: "Limonada", emoji: "üçã", price: 60, baseRecipe: ["üçã", "üçØ"], optionalIngredients: ["üåø"] },
            { name: "Salada", emoji: "ü•ó", price: 100, baseRecipe: ["ü•¨", "üçÖ", "ü•í"], optionalIngredients: ["üßÖ", "ü•ë", "üåΩ", "ü•ö"] }, // Rank Up
            
            // Tier 2
            { name: "Vitamina", emoji: "ü•ë", price: 120, baseRecipe: ["ü•ë", "ü•õ", "üçØ"], optionalIngredients: ["üçì"] },
            { name: "Sushi", emoji: "üç£", price: 150, baseRecipe: ["üçô", "üêü", "ü•í"], optionalIngredients: ["ü•ë"] },
            { name: "Hamb√∫rguer", emoji: "üçî", price: 200, baseRecipe: ["üçû", "ü•©", "ü•¨", "üçû"], optionalIngredients: ["üßÄ", "üçÖ", "ü•ì", "üßÖ"] }, // Rank Up
            
            // Tier 3
            { name: "Panquecas", emoji: "ü•û", price: 220, baseRecipe: ["ü•û", "üßà", "üçØ"], optionalIngredients: ["üçì", "ü´ê"] },
            { name: "Cachorro-Quente", emoji: "üå≠", price: 250, baseRecipe: ["üå≠", "ü•ì"], optionalIngredients: ["üßÖ", "ü•í", "üå∂Ô∏è"] },
            { name: "Waffles", emoji: "üßá", price: 280, baseRecipe: ["üßá", "üßà", "üçì"], optionalIngredients: ["ü´ê", "üçØ"] },
            { name: "Omelete", emoji: "üç≥", price: 300, baseRecipe: ["ü•ö", "ü•ö", "üßà"], optionalIngredients: ["üßÄ", "üçÑ", "üåø", "üçÖ"] },
            { name: "Taco", emoji: "üåÆ", price: 350, baseRecipe: ["üåÆ", "ü•©", "ü•¨"], optionalIngredients: ["üçÖ", "üßÄ", "üå∂Ô∏è"] }, // Rank Up

            // Tier 4
            { name: "Frango c/ Legumes", emoji: "üçó", price: 320, baseRecipe: ["üçó", "ü•¶", "ü•ï"], optionalIngredients: ["üåø"] },
            { name: "Sandu√≠che de Atum", emoji: "ü•™", price: 380, baseRecipe: ["üçû", "üêü", "ü•¨"], optionalIngredients: ["üçÖ", "üßÖ"] },
            { name: "Kebab", emoji: "ü•ô", price: 400, baseRecipe: ["üçû", "üçó", "ü•¨"], optionalIngredients: ["üçÖ", "üßÖ"] },
            { name: "Onigiri", emoji: "üçô", price: 450, baseRecipe: ["üçô", "üçö", "üêü"], optionalIngredients: ["üåø"] },
            { name: "Pizza Slice", emoji: "üçï", price: 500, baseRecipe: ["üçï", "üçÖ", "üßÄ"], optionalIngredients: ["üå∂Ô∏è", "ü•ì", "üçÑ"] }, // Rank Up

            // Tier 5
            { name: "Ensopado", emoji: "üç≤", price: 550, baseRecipe: ["ü•î", "ü•ï", "üßÖ"], optionalIngredients: ["ü•¶", "ü•©"] },
            { name: "Ratatouille", emoji: "üç≤", price: 600, baseRecipe: ["üçÖ", "üçÜ", "ü•í"], optionalIngredients: ["üßÖ", "üåø"] },
            { name: "Guioza", emoji: "ü•ü", price: 650, baseRecipe: ["ü•ü", "ü•©", "ü•¨"], optionalIngredients: ["üßÖ"] },
            { name: "Temaki", emoji: "üç£", price: 750, baseRecipe: ["üçô", "üçö", "üêü", "ü•ë"], optionalIngredients: ["ü•í"] },
            { name: "Ramen", emoji: "üçú", price: 800, baseRecipe: ["üçú", "ü•©", "ü•ö"], optionalIngredients: ["üåø", "üåΩ"] }, // Rank Up

            // Tier 6
            { name: "Salada de Frutas", emoji: "üçì", price: 800, baseRecipe: ["üçì", "üçç"], optionalIngredients: ["ü•ë", "ü´ê", "üçØ"] },
            { name: "Camar√£o", emoji: "ü¶ê", price: 850, baseRecipe: ["ü¶ê", "üßà", "üåø"], optionalIngredients: ["üçã"] },
            { name: "Salm√£o Grelhado", emoji: "üêü", price: 1000, baseRecipe: ["üêü", "üçã", "üåø"], optionalIngredients: ["ü•î"] } // Rank Up
        ];

        // (NOVO) Sistema de Ranks
        const RANKS = [
            { name: "Lava-pratos", icon: "üßº", recipeToUnlock: "Salada" }, // Rank 0
            { name: "Ajudante de Cozinha", icon: "üßë‚Äçüç≥", recipeToUnlock: "Hamb√∫rguer" }, // Rank 1
            { name: "Cozinheiro J√∫nior", icon: "üî™", recipeToUnlock: "Taco" }, // Rank 2
            { name: "Cozinheiro Pleno", icon: "ü•ò", recipeToUnlock: "Pizza Slice" }, // Rank 3
            { name: "Subchefe", icon: "ü•à", recipeToUnlock: "Ramen" }, // Rank 4
            { name: "Chefe de Cozinha", icon: "ü•á", recipeToUnlock: "Salm√£o Grelhado" }, // Rank 5
            { name: "Mestre Cuca", icon: "üèÜ", recipeToUnlock: null } // Rank 6 (M√°x)
        ];

        // --- 2. VARI√ÅVEIS DE ESTADO DO JOGO ---
        const SAVE_KEY = 'recipeGameData_v2'; // Chave salva

        // Estado do jogo salvo
        let gameState = {
            money: 50,
            unlockedRecipeNames: ["Misto Quente"],
            unlockedIngredientEmojis: ["üçû", "üßà", "üßÄ", "üçÖ"], // (MODIFICADO) Tomate √© opcional inicial
            rank: 0 // (NOVO) Ranque inicial
        };

        // Estado da sess√£o (n√£o salvo)
        let currentStreak = 0;
        let currentOrder = null;
        let playerSelection = [];
        let timer = 10;
        let timerId = null;
        let gameActive = false;
        let isPaused = false;
        
        // (MODIFICADO) Economia Rebalanceada
        const REWARD_SUCCESS = 15; // Reduzido de 30
        const PENALTY_FAILURE = 10; // Reduzido de 25
        const STREAK_BONUS = 3; // Reduzido de 5

        // --- 3. SELETORES DO DOM ---
        // Telas
        const menuScreen = document.getElementById('menu-screen');
        const gameScreen = document.getElementById('game-screen');
        const marketScreen = document.getElementById('market-screen');
        const pauseScreen = document.getElementById('pause-screen');
        const marketMessageModal = document.getElementById('market-message-modal');

        // Bot√µes de Navega√ß√£o
        const playButton = document.getElementById('play-button');
        const marketButton = document.getElementById('market-button');
        const pauseButton = document.getElementById('pause-button');
        const resumeButton = document.getElementById('resume-button');
        const menuButtonPause = document.getElementById('menu-button-pause');
        const menuButtonMarket = document.getElementById('menu-button-market');
        const marketMessageClose = document.getElementById('market-message-close');

        // Displays de Dinheiro
        const moneyDisplayGame = document.getElementById('money-display-game');
        const moneyDisplayMarket = document.getElementById('money-display-market');
        const streakDisplay = document.getElementById('streak-display');
        
        // (NOVOS) Displays de Ranque (Menu)
        const rankIcon = document.getElementById('rank-icon');
        const rankName = document.getElementById('rank-name');
        const rankGoal = document.getElementById('rank-goal');
        const rankGoalText = document.getElementById('rank-goal-text');

        // Jogo
        const npcDisplay = document.getElementById('npc-display');
        const dishEmoji = document.getElementById('dish-emoji');
        const dishName = document.getElementById('dish-name');
        const orderDisplay = document.getElementById('order-display');
        const recipeList = document.getElementById('recipe-list');
        const timerText = document.getElementById('timer-text');
        const timerBarInner = document.getElementById('timer-bar-inner');
        const playerPlate = document.getElementById('player-plate');
        const messageBox = document.getElementById('message-box');
        const ingredientBin = document.getElementById('ingredient-bin');
        const orderArea = document.getElementById('order-area');

        // Mercado
        const marketItemsGrid = document.getElementById('market-items-grid');
        const marketMessageIcon = document.getElementById('market-message-icon');
        const marketMessageTitle = document.getElementById('market-message-title');
        const marketMessageText = document.getElementById('market-message-text');

        // --- 4. FUN√á√ïES DE NAVEGA√á√ÉO E ESTADO ---

        /**
         * Mostra uma tela e oculta as outras
         */
        function showScreen(screenId) {
            [menuScreen, gameScreen, marketScreen].forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        /**
         * Salva o estado do jogo no localStorage
         */
        function saveGame() {
            localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
        }

        /**
         * Carrega o estado do jogo do localStorage
         */
        function loadGame() {
            const savedData = localStorage.getItem(SAVE_KEY);
            if (savedData) {
                gameState = JSON.parse(savedData);
            }
            // Garante que os dados iniciais existam se for um save antigo
            if (!gameState.unlockedRecipeNames) {
                gameState.unlockedRecipeNames = ["Misto Quente"];
                gameState.unlockedIngredientEmojis = ["üçû", "üßà", "üßÄ", "üçÖ"];
            }
            // (NOVO) Garante compatibilidade de ranque
            if (gameState.rank === undefined) {
                gameState.rank = 0;
            }
            updateAllMoneyDisplays();
            updateRankDisplay(); // (NOVO) Atualiza a UI de ranque
        }

        /**
         * (NOVO) Atualiza a UI de Ranque no Menu
         */
        function updateRankDisplay() {
            const currentRank = RANKS[gameState.rank];
            rankIcon.textContent = currentRank.icon;
            rankName.textContent = currentRank.name;

            const nextRank = RANKS[gameState.rank + 1];
            if (nextRank) {
                rankGoal.style.display = 'block';
                rankGoalText.textContent = `Compre a receita "${nextRank.recipeToUnlock}" no Mercado!`;
                playButton.classList.remove('bg-yellow-500'); // Garante que n√£o est√° em modo "final"
                playButton.classList.add('bg-green-500');
            } else {
                // Ranque M√°ximo
                rankGoal.style.display = 'none';
                rankName.textContent = "Mestre Cuca"; // Nome especial
                rankIcon.textContent = "üèÜ";
                playButton.classList.remove('bg-green-500');
                playButton.classList.add('bg-yellow-500'); // Bot√£o dourado
            }
        }

        /**
         * Volta para o menu principal
         */
        function goToMenu() {
            gameActive = false; // Para o jogo
            isPaused = false;
            clearInterval(timerId); // Para o timer
            pauseScreen.classList.add('hidden'); // Esconde a pausa
            showScreen('menu-screen');
            updateAllMoneyDisplays(); 
            updateRankDisplay(); // (NOVO) Atualiza o ranque ao voltar
        }

        /**
         * Inicia o jogo
         */
        function startGame() {
            showScreen('game-screen');
            renderUnlockedIngredientBin();
            startNewOrder();
        }

        /**
         * Mostra o mercado
         */
        function showMarket() {
            showScreen('market-screen');
            renderMarket();
            updateAllMoneyDisplays();
        }

        /**
         * Mostra uma mensagem no modal do mercado
         */
        function showMarketMessage(title, text, isSuccess = true) {
            marketMessageTitle.textContent = title;
            marketMessageText.textContent = text;
            
            marketMessageIcon.classList.remove(isSuccess ? 'fa-times-circle' : 'fa-check-circle', isSuccess ? 'text-red-500' : 'text-green-500');
            marketMessageIcon.classList.add(isSuccess ? 'fa-check-circle' : 'fa-times-circle', isSuccess ? 'text-green-500' : 'text-red-500');
            
            marketMessageModal.classList.remove('hidden');
            marketMessageModal.classList.add('flex');
        }

        // --- 5. FUN√á√ïES DE L√ìGICA DO MERCADO ---

        /**
         * Renderiza os itens no mercado
         */
        function renderMarket() {
            marketItemsGrid.innerHTML = '';
            
            const nextRank = RANKS[gameState.rank + 1];

            ALL_RECIPES.forEach(recipe => {
                const isUnlocked = gameState.unlockedRecipeNames.includes(recipe.name);
                // (NOVO) Verifica se √© a receita para subir de ranque
                const isRankUpRecipe = nextRank && recipe.name === nextRank.recipeToUnlock && !isUnlocked;
                
                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-lg p-4 flex items-center space-x-4 transition-all ${isUnlocked ? 'opacity-70' : ''} ${isRankUpRecipe ? 'rank-up-card' : ''}`;
                
                // Mostra todos os ingredientes (base + opcionais)
                const allRecipeIngredients = [...recipe.baseRecipe, ...recipe.optionalIngredients];
                const uniqueIngredients = [...new Set(allRecipeIngredients)]; // Remove duplicatas
                let ingredientsHTML = uniqueIngredients
                    .map(emoji => `<span class="text-sm">${emoji}</span>`)
                    .join(' + ');

                card.innerHTML = `
                    <div class="text-5xl">${recipe.emoji}</div>
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-gray-800">${recipe.name}</h4>
                        <p class="text-gray-500 text-sm">${ingredientsHTML}</p>
                    </div>
                    ${isUnlocked ? 
                        `<div class="text-green-500 font-bold px-4 py-2 rounded-lg bg-green-100">Comprado</div>` :
                        `<button class="btn-main ${isRankUpRecipe ? 'bg-yellow-500' : 'bg-purple-500'} text-white font-bold px-6 py-3 rounded-lg text-lg" data-recipe="${recipe.name}">
                            <i class="fas ${isRankUpRecipe ? 'fa-star' : 'fa-coins'} mr-1"></i> ${recipe.price}
                        </button>`
                    }
                `;
                
                if (!isUnlocked) {
                    card.querySelector('button').addEventListener('click', () => buyRecipe(recipe.name));
                }
                
                marketItemsGrid.appendChild(card);
            });
        }

        /**
         * Tenta comprar uma receita
         */
        function buyRecipe(recipeName) {
            const recipe = ALL_RECIPES.find(r => r.name === recipeName);
            
            if (gameState.money >= recipe.price) {
                // Deduz o dinheiro
                updateMoney(-recipe.price);
                
                // Adiciona a receita
                gameState.unlockedRecipeNames.push(recipe.name);
                
                // Adiciona os ingredientes base E os opcionais (usando Set para evitar duplicatas)
                const ingredientsSet = new Set(gameState.unlockedIngredientEmojis);
                recipe.baseRecipe.forEach(ingredient => ingredientsSet.add(ingredient));
                recipe.optionalIngredients.forEach(ingredient => ingredientsSet.add(ingredient));
                gameState.unlockedIngredientEmojis = Array.from(ingredientsSet);
                
                saveGame();
                renderMarket(); // Re-renderiza o mercado
                
                // (NOVO) Verifica se a compra resultou em subida de ranque
                const nextRank = RANKS[gameState.rank + 1];
                if (nextRank && recipeName === nextRank.recipeToUnlock) {
                    gameState.rank++;
                    saveGame();
                    showMarketMessage("Voc√™ subiu de ranque!", `Parab√©ns, voc√™ agora √© ${RANKS[gameState.rank].name}!`, true);
                    renderMarket(); // Re-renderiza para remover o destaque
                } else {
                    showMarketMessage("Receita Comprada!", `Voc√™ aprendeu a fazer ${recipe.name}!`, true);
                }

            } else {
                // Dinheiro insuficiente
                showMarketMessage("Dinheiro Insuficiente!", `Voc√™ precisa de $${recipe.price} para comprar ${recipe.name}.`, false);
            }
        }

        // --- 6. FUN√á√ïES PRINCIPAIS DO JOGO ---

        /**
         * (NOVO) Retorna a dura√ß√£o do timer baseada no ranque
         */
        function getTimerDuration() {
            const baseTimer = 12; // 12 segundos no ranque 0
            const duration = baseTimer - gameState.rank; // Perde 1s por ranque
            return Math.max(duration, 5); // M√≠nimo de 5 segundos
        }

        /**
         * Renderiza APENAS os ingredientes desbloqueados
         */
        function renderUnlockedIngredientBin() {
            ingredientBin.innerHTML = '';
            // Embaralha apenas os ingredientes desbloqueados
            const shuffledIngredients = [...gameState.unlockedIngredientEmojis].sort(() => Math.random() - 0.5);
            
            shuffledIngredients.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = "ingredient-btn rounded-lg p-3 text-4xl shadow-md no-select";
                btn.textContent = emoji;
                btn.dataset.emoji = emoji;
                ingredientBin.appendChild(btn);
            });
            // Anima√ß√£o da bandeja
            ingredientBin.parentElement.classList.remove('animate-slide-in-bottom');
            void ingredientBin.parentElement.offsetWidth;
            ingredientBin.parentElement.classList.add('animate-slide-in-bottom');
        }

        /**
         * Inicia um novo pedido
         */
        function startNewOrder() {
            gameActive = true;
            isPaused = false;
            playerSelection = [];
            timer = getTimerDuration(); // (MODIFICADO) Timer din√¢mico
            
            // Escolhe uma receita APENAS das desbloqueadas
            const availableRecipes = ALL_RECIPES.filter(r => gameState.unlockedRecipeNames.includes(r.name));
            currentOrder = { ...availableRecipes[Math.floor(Math.random() * availableRecipes.length)] };
            
            // (MODIFICADO) Gerar receita din√¢mica com dificuldade baseada no ranque
            let finalRecipe = [...currentOrder.baseRecipe]; // Come√ßa com a base
            
            // Filtra opcionais que o jogador J√Å DESBLOQUEOU
            const availableOptionals = currentOrder.optionalIngredients.filter(
                ingredient => gameState.unlockedIngredientEmojis.includes(ingredient)
            );
            
            // (MODIFICADO) Chance de adicionar opcionais aumenta com o ranque
            const optionalChance = 0.3 + (gameState.rank * 0.1); // 30% (rank 0) -> 90% (rank 6)
            const optionalsToAdd = availableOptionals.filter(() => Math.random() < optionalChance);

            if (optionalsToAdd.length > 0 && finalRecipe.length > 1) {
                // Insere os opcionais antes do √∫ltimo item da receita base (ex: antes do √∫ltimo p√£o)
                const lastItem = finalRecipe.pop(); // Remove o √∫ltimo item
                finalRecipe = [...finalRecipe, ...optionalsToAdd, lastItem]; // Adiciona opcionais e dps o √∫ltimo item
            } else if (optionalsToAdd.length > 0) {
                // Para receitas de 1 item (ou se a l√≥gica falhar), apenas adiciona no final
                finalRecipe = [...finalRecipe, ...optionalsToAdd];
            }
            
            currentOrder.recipe = finalRecipe;
            
            // Resetar UI
            playerPlate.innerHTML = '';
            messageBox.textContent = '';
            messageBox.className = "text-center text-2xl font-bold";
            
            // Mostra a receita imediatamente (com cor)
            recipeList.innerHTML = `Receita: <span class="font-bold text-purple-600 ml-2">${currentOrder.recipe.join(' ')}</span>`;
            
            // Mostrar novo pedido
            npcDisplay.textContent = NPCS[Math.floor(Math.random() * NPCS.length)];
            dishEmoji.textContent = currentOrder.emoji;
            dishName.textContent = currentOrder.name;
            
            // Anima√ß√£o do pedido
            orderArea.classList.remove('animate-pop-in');
            void orderArea.offsetWidth;
            orderArea.classList.add('animate-pop-in');

            startTimer();
        }

        /**
         * Lida com o clique em um ingrediente
         */
        function handleIngredientClick(e) {
            if (!gameActive || isPaused || !e.target.matches('.ingredient-btn')) return;

            const clickedEmoji = e.target.dataset.emoji;
            playerSelection.push(clickedEmoji);
            
            // Atualiza o prato do jogador (visual)
            const emojiSpan = document.createElement('span');
            emojiSpan.className = 'text-3xl animate-pop-in';
            emojiSpan.textContent = clickedEmoji;
            playerPlate.appendChild(emojiSpan);

            // Verifica√ß√£o de erro imediato (ordem importa!)
            const currentIndex = playerSelection.length - 1;
            if (playerSelection[currentIndex] !== currentOrder.recipe[currentIndex]) {
                checkOrder(false, "Ingrediente errado!");
                return;
            }
            
            // Verifica√ß√£o de sucesso (completou a receita)
            if (playerSelection.length === currentOrder.recipe.length) {
                checkOrder(true);
            }
        }

        /**
         * Inicia o contador regressivo
         */
        function startTimer() {
            clearInterval(timerId);
            timer = getTimerDuration(); // (MODIFICADO) Timer din√¢mico
            timerText.textContent = `Tempo: ${timer}s`;
            
            // Reseta a anima√ß√£o da barra
            timerBarInner.classList.remove('timer-bar-inner-animate');
            void timerBarInner.offsetWidth;
            timerBarInner.classList.add('timer-bar-inner-animate');
            timerBarInner.style.animationDuration = `${timer}s`; // Usa o timer din√¢mico
            timerBarInner.style.animationPlayState = 'running';

            startTimerInterval();
        }

        /**
         * Inicia o intervalo do contador
         */
        function startTimerInterval() {
            clearInterval(timerId);
            timerId = setInterval(() => {
                if (isPaused) return;

                timer--;
                timerText.textContent = `Tempo: ${timer}s`;
                
                if (timer <= 0) {
                    checkOrder(false, "Tempo esgotado!");
                }
            }, 1000);
        }

        /**
         * Pausa o jogo
         */
        function pauseGame() {
            if (!gameActive) return;
            
            isPaused = true;
            clearInterval(timerId);
            timerBarInner.style.animationPlayState = 'paused';
            pauseScreen.classList.remove('hidden');
            pauseScreen.classList.add('flex');
        }

        /**
         * Retoma o jogo
         */
        function resumeGame() {
            if (!gameActive) return;

            isPaused = false;
            startTimerInterval();
            timerBarInner.style.animationPlayState = 'running';
            pauseScreen.classList.add('hidden');
            pauseScreen.classList.remove('flex');
        }

        /**
         * Verifica o pedido
         */
        function checkOrder(isSuccess, failReason = "") {
            if (!gameActive) return;
            
            gameActive = false;
            clearInterval(timerId);
            timerBarInner.classList.remove('timer-bar-inner-animate');
            
            if (isSuccess) {
                // Sucesso
                currentStreak++;
                // (MODIFICADO) B√¥nus de combo rebalanceado
                const streakBonus = currentStreak * STREAK_BONUS; // 3, 6, 9...
                const totalReward = REWARD_SUCCESS + streakBonus;
                
                updateMoney(totalReward);
                
                let successMsg = `Perfeito! +$${REWARD_SUCCESS}`;
                if (streakBonus > 0) {
                    successMsg += ` (Combo +$${streakBonus})`;
                }
                showMessage(successMsg, true);
                
            } else {
                // Falha
                currentStreak = 0;
                const reason = failReason || "Pedido errado!";
                
                // Garante que a penalidade n√£o deixe o dinheiro negativo
                let penalty = PENALTY_FAILURE;
                if (gameState.money < penalty) {
                    penalty = gameState.money; // Perde apenas o que tem
                }
                
                updateMoney(-penalty); // Passa o valor negativo
                showMessage(`${reason} -$${penalty}`, false);
            }
            
            updateStreakDisplay();
            saveGame(); // Salva o progresso (dinheiro e ranque)
            
            // Prepara o pr√≥ximo pedido
            setTimeout(startNewOrder, 2000);
        }

        // --- 7. FUN√á√ïES AUXILIARES DE UI ---

        /**
         * Atualiza TODOS os displays de dinheiro
         */
        function updateAllMoneyDisplays() {
            const moneyStr = `$${gameState.money}`;
            moneyDisplayGame.textContent = moneyStr;
            moneyDisplayMarket.textContent = moneyStr;

            // Anima√ß√£o de "pulso"
            [moneyDisplayGame, moneyDisplayMarket].forEach(display => {
                display.classList.remove('scale-110');
                void display.offsetWidth;
                display.classList.add('scale-110');
                setTimeout(() => display.classList.remove('scale-110'), 200);
            });
        }

        /**
         * Atualiza o dinheiro e chama a atualiza√ß√£o da UI
         */
        function updateMoney(amount) {
            gameState.money += amount;
            
            // Regra principal: Dinheiro NUNCA fica abaixo de 0
            if (gameState.money < 0) {
                gameState.money = 0;
            }
            
            updateAllMoneyDisplays();
        }

        /**
         * Atualiza o visual do combo
         */
        function updateStreakDisplay() {
            if (currentStreak > 1) { // S√≥ mostra o combo a partir de 2x
                streakDisplay.textContent = `${currentStreak}x üî•`;
                streakDisplay.classList.add('animate-pulse-orange');
                setTimeout(() => streakDisplay.classList.remove('animate-pulse-orange'), 300);
            } else {
                streakDisplay.textContent = '';
            }
        }
        
        /**
         * Mostra uma mensagem de feedback
         */
        function showMessage(text, isSuccess) {
            messageBox.textContent = text;
            if (isSuccess) {
                messageBox.classList.add('message-success');
            } else {
                messageBox.classList.add('message-error');
            }
        }

        // --- 8. INICIAR O JOGO ---
        
        // Listeners de navega√ß√£o
        playButton.addEventListener('click', startGame);
        marketButton.addEventListener('click', showMarket);
        
        pauseButton.addEventListener('click', pauseGame);
        resumeButton.addEventListener('click', resumeGame);
        
        menuButtonPause.addEventListener('click', goToMenu);
        menuButtonMarket.addEventListener('click', goToMenu);

        marketMessageClose.addEventListener('click', () => {
            marketMessageModal.classList.add('hidden');
            marketMessageModal.classList.remove('flex');
        });

        // Listeners do Jogo
        ingredientBin.addEventListener('click', handleIngredientClick);
        
        // Carregar o jogo quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', loadGame);

    </script>
</body>
</html>

